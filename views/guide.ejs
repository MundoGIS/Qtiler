<!--
  This Source Code Form is subject to the terms of the Mozilla Public License, v. 2.0.
  If a copy of the MPL was not distributed with this file, You can obtain one at https://mozilla.org/MPL/2.0/.
  Copyright (C) 2025 MundoGIS.
-->

<%
  // Inline guide styles moved to /public/css/guide.css
  const guideStyles = [ { href: '/css/guide.css' } ];
%>
<%- include('partials/html-open', {
  pageLang,
  pageTitle: 'User Guide ¬∑ Qtiler',
  pageTitleI18nKey: 'guide.pageTitle',
  extraStyles: guideStyles
}) %>
    <div class="app-shell guide-shell">
      <%- include('partials/header', {
        headerMode: 'dashboard',
        headerTaglineKey: 'User guide',
        headerTaglineText: 'User guide',
        user,
        activeNav: activeNav || 'guide'
      }) %>

      <main class="app-main">
        <div class="guide-main">
          <div class="guide-topbar">
            <a class="guide-button" href="/index.html" data-i18n="guide.back">‚¨Ö Back to dashboard</a>
          </div>

          <section class="guide-hero">
            <span class="guide-badge">Qtiler ¬∑ MundoGIS</span>
            <h1 data-i18n="guide.heroTitle">Quick Start &amp; Workflow Guide</h1>
            <p data-i18n="guide.heroSubtitle">Everything you need to prepare QGIS projects, build manual or on-demand WMTS caches with Qtiler, secure deployments with the optional auth plugin, and publish production-ready services.</p>
          </section>

          <section class="guide-section">
            <h2><span>1</span> <span data-i18n="guide.section1Title">Getting ready</span></h2>
            <div class="grid two">
              <div class="card-mini">
                <h3 data-i18n="guide.prepareQgis">Prepare QGIS</h3>
                <ul>
                  <li data-i18n="guide.prepareQgis.step1">Create and save your project in QGIS 3.x with all layers styled.</li>
                  <li data-i18n="guide.prepareQgis.step2">Define "Map Themes" (a.k.a. Kartteman) for every layer combination you want to cache as a composite.</li>
                  <li data-i18n-html="guide.prepareQgis.step3">Save the project (<code>Ctrl+S</code>) before uploading so the themes are persisted.</li>
                </ul>
              </div>
              <div class="card-mini">
                <h3 data-i18n="guide.setupServer">Set up the server</h3>
                <ul>
                  <li data-i18n-html="guide.setupServer.step1">Install OSGeo4W or the standalone QGIS build and configure <code>QGIS_PREFIX</code>, <code>OSGEO4W_BIN</code>, <code>PYTHON_EXE</code>.</li>
                  <li data-i18n-html="guide.setupServer.step2">Launch Qtiler with <code>npm start</code> (default <code>http://localhost:3000</code>).</li>
                  <li data-i18n-html="guide.setupServer.step3">Optional: install the Windows Service via <code>node service\\install-service.js</code>.</li>
                </ul>
              </div>
            </div>
            <div class="tip" data-i18n-html="guide.tip1">Already copied projects into <code>qgisprojects/</code>? Just click <strong>Reload layers</strong> to rebuild the list.</div>
          </section>

          <section class="guide-section">
            <h2><span>2</span> <span data-i18n="guide.section2Title">Dashboard workflow</span></h2>
            <p style="margin-bottom:18px;color:var(--muted)" data-i18n-html="guide.dashboardIntro">Here is the end-to-end flow inside the dashboard‚Äîeverything you see ships with Qtiler, no manual assets required.</p>
            <div class="grid two" style="margin-bottom:22px;">
              <div class="card-mini">
                <h3 data-i18n="guide.dashboardOverview">Dashboard overview</h3>
                <p data-i18n-html="guide.dashboardOverview.body">Use the top summary to monitor pending jobs, completed caches, and quick actions like <strong>Reload layers</strong> or <strong>Cache all layers</strong>.</p>
              </div>
              <div class="card-mini">
                <h3 data-i18n="guide.layerControls">Layer controls</h3>
                <p data-i18n-html="guide.layerControls.body">Each row exposes play/delete/copy/view buttons plus shortcuts to manual or on-demand caching so operators never leave the dashboard.</p>
              </div>
            </div>
            <div class="grid two">
              <div class="card-mini">
                <h3 data-i18n="guide.uploadRefresh">1Ô∏è‚É£ Upload or refresh projects</h3>
                <p data-i18n-html="guide.uploadRefresh.body">Use <strong>Upload project</strong> for `.qgs/.qgz` files. Qtiler drops them into <code>qgisprojects/</code> and extracts layers, CRS, extent, and themes. Manual copies work too‚Äîjust hit <strong>Reload layers</strong>.</p>
              </div>
              <div class="card-mini">
                <h3 data-i18n="guide.adjustZoom">2Ô∏è‚É£ Adjust zoom and extent</h3>
                <p data-i18n-html="guide.adjustZoom.body">Set global min/max zoom and open <strong>Show extent map</strong> when you need precise bounding boxes. The map supports deep zoom (‚âà1:100) so you can refine the box in WGS84.</p>
              </div>
              <div class="card-mini">
                <h3 data-i18n="guide.cachePerLayer">3Ô∏è‚É£ Cache per layer</h3>
                <p data-i18n="guide.cachePerLayer.intro">Each layer row offers:</p>
                <ul>
                  <li data-i18n="guide.cachePerLayer.option1">‚ñ∂ Generate/refresh cache.</li>
                  <li data-i18n="guide.cachePerLayer.option2">üóë Delete stored tiles.</li>
                  <li data-i18n="guide.cachePerLayer.option3">üìã Copy tile URL (`/wmts/&lt;project&gt;/&lt;layer&gt;/{z}/{x}/{y}.png`).</li>
                  <li data-i18n="guide.cachePerLayer.option4">üëÅ Open the Leaflet viewer in the layer‚Äôs native CRS.</li>
                </ul>
              </div>
              <div class="card-mini">
                <h3 data-i18n="guide.cachePerTheme">4Ô∏è‚É£ Cache per theme</h3>
                <p data-i18n-html="guide.cachePerTheme.body">The <strong>Map Themes</strong> section lists every theme found. Use ‚ñ∂ to generate the composite mosaic (`/wmts/&lt;project&gt;/themes/&lt;theme&gt;/‚Ä¶`). Copy the WMTS URL and preview it in the viewer.</p>
              </div>
            </div>
          </section>

          <section class="guide-section">
            <h2><span>3</span> <span data-i18n="guide.section3Title">Jobs &amp; automation</span></h2>
            <div class="grid two">
              <div class="card-mini">
                <h3 data-i18n="guide.projectWideCache">Project-wide cache</h3>
                <p data-i18n-html="guide.projectWideCache.body"><strong>Cache all layers</strong> launches a batch job that iterates over every layer with the current parameters. The ‚ÄúRunning tasks‚Äù panel tracks progress live.</p>
              </div>
              <div class="card-mini">
                <h3 data-i18n="guide.scheduledRecache">Scheduled recache</h3>
                <p data-i18n-html="guide.scheduledRecache.body">Open the recache menu to define minute-based intervals. The server records last result and next run inside <code>project-config.json</code>.</p>
              </div>
              <div class="card-mini">
                <h3 data-i18n="guide.onDemandCacheTitle">On-demand caching</h3>
                <p data-i18n-html="guide.onDemandCache.body">Qtiler can serve tiles directly from QGIS whenever a WMTS request misses the cache. Each live render is written back to disk, so manual batch jobs and on-demand traffic stay perfectly aligned.</p>
              </div>
            </div>
            <div class="tip" data-i18n-html="guide.tip2">Caches live under <code>cache/&lt;project&gt;/</code>. Each run updates <code>index.json</code> with <code>kind</code>, zooms, source layers, and timestamps.</div>
          </section>

          <section class="guide-section">
            <h2><span>4</span> <span data-i18n="guide.section4Title">Publishing WMTS</span></h2>
            <p data-i18n-html="guide.section4.body">The backend exposes a minimal GetCapabilities endpoint at <code>/wmts?SERVICE=WMTS&amp;REQUEST=GetCapabilities&amp;project=&lt;id&gt;</code>. All cached layers and themes appear as individual WMTS layers with ready-to-use templates.</p>
            <div class="grid two">
              <div class="card-mini">
                <h3 data-i18n="guide.gisIntegration">GIS client integration</h3>
                <ul>
                  <li data-i18n="guide.gisIntegration.body1">Load the Capabilities URL to register every layer at once.</li>
                  <li data-i18n="guide.gisIntegration.body2">Use individual tile URLs when you only need a specific resource.</li>
                  <li data-i18n-html="guide.gisIntegration.body3">Themes are identified as <code>&lt;project&gt;:&lt;theme&gt;</code> and stored under <code>_themes/</code>.</li>
                </ul>
              </div>
              <div class="card-mini">
                <h3>WMS &amp; WFS endpoints</h3>
                <p style="margin-bottom:10px;color:var(--muted)">In addition to WMTS/XYZ tiles, Qtiler also exposes WMS and WFS endpoints per project:</p>
                <ul>
                  <li><strong>WMS GetCapabilities</strong>: <code>/wms?SERVICE=WMS&amp;REQUEST=GetCapabilities&amp;project=&lt;id&gt;</code></li>
                  <li><strong>WFS GetCapabilities</strong>: <code>/wfs?SERVICE=WFS&amp;REQUEST=GetCapabilities&amp;project=&lt;id&gt;</code></li>
                  <li><strong>WFS read</strong> (GeoJSON): <code>/wfs?SERVICE=WFS&amp;REQUEST=GetFeature&amp;OUTPUTFORMAT=application/json&amp;TYPENAME=&lt;layer&gt;&amp;project=&lt;id&gt;</code></li>
                </ul>
                <div class="tip" style="margin-top:12px;">WFS-T (editing) uses <code>POST /wfs?project=&lt;id&gt;</code> with an XML <code>&lt;wfs:Transaction&gt;</code> body and may require admin access depending on your auth setup.</div>
              </div>
              <div class="card-mini">
                <h3 data-i18n="guide.leafletViewer">Leaflet viewer</h3>
                <p data-i18n-html="guide.leafletViewer.body">Launch the Leaflet viewer from the eye icon next to each layer or theme. Compare cached tiles against the remote source or preview the cache on its own.</p>
              </div>
              <div class="card-mini" style="grid-column: 1 / -1;">
                <h3 data-i18n="guide.origoTitle">Using Qtiler with Origo Map</h3>
                <p data-i18n-html="guide.origo.body">For Origo-based portals, point the source to the REST XYZ template (not GetCapabilities) and keep the native CRS. Example source configuration:</p>
                <pre><code>{
  "source": "Qtiler_Topografiska_Webbkartan",
  "url": "https://ext.rabbalshedekraft.se/wmts/bakgrunder/Topografiska_Webbkartan/{z}/{x}/{y}.png",
  "type": "XYZ",
  "projection": "EPSG:3006"
}</code></pre>
                <p data-i18n-html="guide.origo.layerLabel">Example layer entry that references the source:</p>
                <pre><code>{
  "name": "bakgrunder_Topografiska_Webbkartan",
  "title": "Topografiska_Webbkartan",
  "group": "background",
  "source": "Qtiler_Topografiska_Webbkartan",
  "type": "XYZ",
  "format": "image/png",
  "visible": true,
  "style": "karta_farg",
  "attribution": "&copy; Lantm√§teriet",
  "tileGrid": {
    "alignBottomLeft": false,
    "origin": [ -908609.3787282843, 7825048.779051208 ],
    "resolutions": [
      11426.844956133727, 5713.422478066864, 2856.711239033432,
      1428.355619516716, 714.177809758358, 357.088904879179,
      178.5444524395895, 89.27222621979475, 44.63611310989737,
      22.318056554948686, 11.159028277474343, 5.579514138737172,
      2.789757069368586, 1.394878534684293, 0.6974392673421465,
      0.3487196336710732, 0.1743598168355366, 0.0871799084177683,
      0.04358995420888415, 0.021794977104442077, 0.010897488552221038,
      0.005448744276110519, 0.0027243721380552596
    ]
  }
}</code></pre>

                <h4 style="margin-top:18px;">Origo editing via WFS-T (example)</h4>
                <p style="margin-bottom:10px;color:var(--muted)">To enable editing in Origo, configure a WFS source (base endpoint) and mark the layer editable. Origo will send <code>Transaction</code> requests (WFS-T) to the source URL via <code>POST</code>.</p>
                <p style="margin-bottom:10px;"><strong>Example WFS source</strong> (note: <code>url</code> is the base endpoint, not a GetCapabilities URL):</p>
                <pre><code>{
  "source": "Qtiler_WFS",
  "type": "WFS",
  "url": "http://localhost:3000/wfs?project=po",
  "workspace": "http://localhost:3000/qtiler/po",
  "projection": "EPSG:3006"
}</code></pre>
                <p style="margin-bottom:10px;"><strong>Example editable layer</strong>:</p>
                <pre><code>{
  "name": "PO_delar",
  "title": "PO_delar",
  "type": "WFS",
  "source": "Qtiler_WFS",
  "featureType": "PO_delar",
  "geometryName": "geometry",
  "editable": true,
  "attributes": [
    { "name": "GID", "type": "integer", "hidden": true },
    { "name": "NAMN", "type": "string" },
    { "name": "Status", "type": "string" },
    { "name": "Beskrivning", "type": "string" }
  ]
}</code></pre>
                <div class="tip" style="margin-top:12px;">Server-side requirements: the datasource must allow writes (DB permissions/constraints). Depending on your deployment, WFS-T may require an admin session. Primary keys are usually auto-generated by the database.</div>
                <div class="tip" data-i18n="guide.origo.extentTip">Get the origin, resolutions, and extent from the layer/theme info dialog (‚ìò) in the dashboard. Copy the values from the "Layer Details" modal under WMTS URLs.</div>
              </div>
            </div>
          </section>

          <section class="guide-section">
            <h2><span>5</span> <span data-i18n="guide.sectionAuthTitle">Authentication &amp; access control</span></h2>
            <p data-i18n-html="guide.authPluginIntro">Install the optional <code>QtilerAuth</code> plugin (see <code>plugins/QtilerAuth</code>) whenever you need login-protected dashboards or customer-specific WMTS access.</p>
            <ul>
              <li data-i18n="guide.authPlugin.userMgmt">Manage users and roles from the built-in admin UI, including password resets and project-level permissions.</li>
              <li data-i18n="guide.authPlugin.portal">Apply consistent authentication across the portal, Leaflet viewer, and WMTS endpoints so only authorized clients reach cached tiles.</li>
              <li data-i18n="guide.authPlugin.setup">Download the one-time QtilerAuth ZIP from mundogis.se and upload it through the built-in plugin installer to deploy‚Äîno floating licenses or repeat activations.</li>
            </ul>
            <div class="tip" data-i18n-html="guide.authPlugin.purchase">QtilerAuth ships as a one-time ZIP purchase: download it from <a href="https://mundogis.se" target="_blank" rel="noopener">mundogis.se</a>, upload it through the portal installer, and email <a href="mailto:abel.gonzalez@mundogis.se">abel.gonzalez@mundogis.se</a> for personalized guidance.</div>
          </section>

          <section class="guide-section">
            <h2><span>6</span> <span data-i18n="guide.section5Title">Best practices</span></h2>
            <ul>
              <li data-i18n="guide.bestPractice1">Keep QGIS projects and themes organized‚Äînames map directly to WMTS paths.</li>
              <li data-i18n="guide.bestPractice2">Monitor disk usage; WMTS caches can grow fast. Clean up unused layers regularly.</li>
              <li data-i18n-html="guide.bestPractice3">Review logs (`logs/`) and UI status messages to catch render errors early.</li>
              <li data-i18n="guide.bestPractice4">Use dedicated Windows accounts and background services for production deployments.</li>
            </ul>
          </section>

          <p class="guide-note" data-i18n="guide.footer">
            Need to customize further? Update the repository README with team-specific notes, purchase Qtiler via mundogis.se, or email abel.gonzalez@mundogis.se for more details.
          </p>
        </div>
      </main>

      <%- include('partials/footer', {
        footerClass: 'portal-footer',
        footerYearId: 'guide_footer_year'
      }) %>
    </div>

    <script>
      (function(){
        const SUPPORTED_LANGS = (window.qtilerLang && Array.isArray(window.qtilerLang.SUPPORTED_LANGS))
          ? window.qtilerLang.SUPPORTED_LANGS
          : ["en", "es", "sv"];
        const DEFAULT_TEXT = {};
        const DEFAULT_HTML = {};

        const normalizeLang = window.qtilerLang?.normalize || ((value) => {
          const raw = (value || "").toLowerCase();
          if (SUPPORTED_LANGS.includes(raw)) return raw;
          const base = raw.split("-")[0];
          return SUPPORTED_LANGS.includes(base) ? base : "en";
        });

        let currentLang = window.qtilerLang?.get?.() || normalizeLang(localStorage.getItem("qtiler.lang") || navigator.language || "en");

        const captureDefaults = () => {
          document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (!key || key in DEFAULT_TEXT) return;
            const explicit = el.getAttribute("data-i18n-default");
            DEFAULT_TEXT[key] = explicit != null ? explicit : el.textContent.trim();
          });
          document.querySelectorAll("[data-i18n-html]").forEach(el => {
            const key = el.getAttribute("data-i18n-html");
            if (!key || key in DEFAULT_HTML) return;
            const explicit = el.getAttribute("data-i18n-default");
            DEFAULT_HTML[key] = explicit != null ? explicit : el.innerHTML.trim();
          });
        };

        const tr = (key, asHtml = false) => {
          if (!key) return "";
          try {
            if (window.qtilerI18n && typeof window.qtilerI18n.t === 'function') {
              const central = window.qtilerI18n.t(key);
              if (central && central !== key) return central;
            }
          } catch (e) {}
          if (asHtml) return DEFAULT_HTML[key] ?? DEFAULT_TEXT[key] ?? "";
          return DEFAULT_TEXT[key] ?? DEFAULT_HTML[key] ?? "";
        };

        const applyTranslations = () => {
          document.documentElement.setAttribute("lang", currentLang);
          const titleTranslation = tr("guide.pageTitle");
          if (titleTranslation) document.title = titleTranslation;
          document.querySelectorAll("[data-i18n]").forEach(el => {
            const key = el.getAttribute("data-i18n");
            if (!key) return;
            el.textContent = tr(key, false);
          });
          document.querySelectorAll("[data-i18n-html]").forEach(el => {
            const key = el.getAttribute("data-i18n-html");
            if (!key) return;
            el.innerHTML = tr(key, true);
          });
          const backLink = document.querySelector('a[data-i18n="guide.back"]');
          if (backLink) backLink.setAttribute("aria-label", tr("guide.back"));
        };

        const navLanguageSelect = document.getElementById("language_selector");

        if (window.qtilerLang?.subscribe) {
          window.qtilerLang.subscribe((lang) => {
            const normalized = normalizeLang(lang);
            if (normalized === currentLang) return;
            currentLang = normalized;
            applyTranslations();
            syncLanguageSelect();
          });
        }

        const syncLanguageSelect = () => {
          if (navLanguageSelect) navLanguageSelect.value = currentLang;
        };

        const setLanguage = (lang) => {
          if (window.qtilerLang?.set) {
            window.qtilerLang.set(lang);
            return;
          }
          currentLang = normalizeLang(lang);
          try {
            localStorage.setItem("qtiler.lang", currentLang);
          } catch {}
          applyTranslations();
          syncLanguageSelect();
        };

        captureDefaults();
        applyTranslations();
        syncLanguageSelect();

        if (navLanguageSelect) {
          navLanguageSelect.addEventListener("change", (event) => setLanguage(event.target.value));
        }

        const footerYearEl = document.getElementById("guide_footer_year");
        if (footerYearEl) footerYearEl.textContent = String(new Date().getFullYear());
      })();
    </script>
<%- include('partials/html-close') %>
