<%
  // Inline access-denied styles moved to /public/css/access-denied.css
  const deniedStyles = [ { href: '/css/access-denied.css' } ];
%>
<%- include('partials/html-open', {
  pageLang,
  pageTitle: 'Qtiler Â· Access denied',
  pageTitleI18nKey: 'access.title',
  extraStyles: deniedStyles
}) %>
    <%- include('partials/header', {
      headerMode: 'access',
      headerTaglineKey: 'access.title',
      headerTaglineText: 'Access denied',
      user,
      activeNav: activeNav || 'dashboard'
    }) %>
    <div class="denied-card" role="alert">
      <h1 data-i18n="access.heading">Access denied</h1>
      <p data-i18n="access.detail">Your account is not authorized to view the Qtiler dashboard. If you need access, please contact an administrator.</p>
      <p data-i18n="access.tip">You can still use any WMTS endpoints that have been shared with you directly.</p>
      <div class="denied-actions">
        <a class="denied-button" href="/login" data-i18n="access.cta">Return to sign in</a>
      </div>
    </div>

    <script>
      (function () {
        const SUPPORTED_LANGS = (window.qtilerLang && Array.isArray(window.qtilerLang.SUPPORTED_LANGS))
          ? window.qtilerLang.SUPPORTED_LANGS
          : ["en", "es", "sv"];
        const normalizeLang = window.qtilerLang?.normalize || ((value) => {
          const raw = (value || "").toLowerCase();
          if (SUPPORTED_LANGS.includes(raw)) return raw;
          const base = raw.split("-")[0];
          return SUPPORTED_LANGS.includes(base) ? base : "en";
        });
        let currentLang = window.qtilerLang?.get?.() || normalizeLang(localStorage.getItem("qtiler.lang") || navigator.language || "en");

        const languageSelect = document.getElementById('language_selector');

        const tr = (key) => {
          if (!key) return '';
          try {
            if (window.qtilerI18n && typeof window.qtilerI18n.t === 'function') return window.qtilerI18n.t(key);
          } catch (e) {}
          return key;
        };

        const applyTranslations = () => {
          try {
            if (document?.documentElement) document.documentElement.setAttribute('lang', window.qtilerLang?.get?.() || currentLang);
            const pageTitle = document.querySelector('title[data-i18n="access.title"]');
            if (pageTitle) pageTitle.textContent = tr('access.title');
            if (window.qtilerI18n && typeof window.qtilerI18n.apply === 'function') {
              try { window.qtilerI18n.apply(); } catch (e) {}
            }
            if (languageSelect) languageSelect.value = window.qtilerLang?.get?.() || currentLang;
          } catch (e) {}
        };

        const setLanguage = (lang) => {
          if (window.qtilerLang?.set) {
            window.qtilerLang.set(lang);
            return;
          }
          currentLang = normalizeLang(lang);
          try {
            localStorage.setItem('qtiler.lang', currentLang);
          } catch {}
          applyTranslations();
        };

        if (languageSelect) {
          languageSelect.value = currentLang;
          languageSelect.addEventListener('change', (event) => setLanguage(event.target.value));
        }

        if (window.qtilerLang?.subscribe) {
          window.qtilerLang.subscribe((lang) => {
            const normalized = normalizeLang(lang);
            if (normalized === currentLang) return;
            currentLang = normalized;
            applyTranslations();
          });
        }

        applyTranslations();
      })();
    </script>
<%- include('partials/html-close') %>
