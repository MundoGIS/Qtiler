<%
  const loginHeadStyles = String.raw`
    <style>
      body {
        background: var(--bg, #f8fafc);
        color: var(--fg, #0f172a);
      }
      .login-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px 16px;
      }
      .login-card {
        width: 100%;
        max-width: 420px;
        background: var(--card, #ffffff);
        border-radius: 18px;
        padding: 32px;
        box-shadow: var(--shadow, 0 18px 45px rgba(15, 23, 42, 0.09));
        border: 1px solid var(--border, rgba(15, 23, 42, 0.08));
      }
      .login-card h1 {
        margin: 0 0 12px 0;
        font-size: 24px;
        font-weight: 700;
        letter-spacing: -0.3px;
      }
      .login-card p {
        margin: 0 0 24px 0;
        color: var(--muted, #475569);
      }
      .login-field {
        margin-bottom: 18px;
      }
      .login-field label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 6px;
        color: var(--muted, #475569);
      }
      .login-field input {
        width: 100%;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px solid var(--border, rgba(15, 23, 42, 0.12));
        font-size: 15px;
        background: #fff;
      }
      .password-wrapper {
        position: relative;
      }
      .password-wrapper input {
        padding-right: 40px;
      }
      .password-toggle {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        color: var(--muted, #475569);
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
      }
      .password-toggle:hover {
        background: rgba(0,0,0,0.05);
        color: var(--fg, #0f172a);
      }
      .login-remember {
        margin-top: -6px;
        margin-bottom: 8px;
      }
      .remember-toggle {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--muted, #475569);
        cursor: pointer;
      }
      .remember-toggle input[type="checkbox"] {
        width: 16px;
        height: 16px;
      }
      .login-footer {
        margin-top: 24px;
        font-size: 13px;
        color: var(--muted, #6b7280);
      }
      .login-actions {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 12px;
      }
      .login-button {
        display: inline-flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        border: none;
        border-radius: 999px;
        padding: 12px 18px;
        font-weight: 600;
        letter-spacing: 0.2px;
        cursor: pointer;
        background: var(--primary, #2563eb);
        color: #fff;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }
      .login-button:hover,
      .login-button:focus {
        transform: translateY(-1px);
        box-shadow: 0 12px 24px rgba(37, 99, 235, 0.25);
      }
      .login-status {
        min-height: 20px;
        margin-top: 12px;
        font-size: 14px;
      }
      .login-status[data-state="error"] {
        color: #dc2626;
      }
      .login-status[data-state="success"] {
        color: #16a34a;
      }
      .login-help {
        font-size: 13px;
        color: var(--muted, #64748b);
      }
      a.login-link {
        color: var(--primary, #2563eb);
        text-decoration: none;
      }
      a.login-link:hover,
      a.login-link:focus {
        text-decoration: underline;
      }
    </style>
  `;
%>
<%- include('partials/html-open', {
  pageLang,
  pageTitle: 'Qtiler · Sign in',
  pageTitleI18nKey: 'login.pageTitle',
  inlineHeadContent: loginHeadStyles
}) %>
    <%- include('partials/header', { headerMode: 'login', user, activeNav: activeNav || null }) %>
    <div class="login-container">
      <div class="login-card" role="dialog" aria-labelledby="login_title">
        <h1 id="login_title" data-i18n="login.heading">Sign in to Qtiler</h1>
        <p data-i18n="login.intro">Authenticate with your credentials to access the dashboard.</p>
        <form id="login_form" autocomplete="off">
          <div class="login-field">
            <label for="login_username" data-i18n="login.label.username">Username</label>
            <input id="login_username" name="username" type="text" required autofocus autocomplete="off" data-i18n-placeholder="login.label.username">
          </div>
          <div class="login-field">
            <label for="login_password" data-i18n="login.label.password">Password</label>
            <div class="password-wrapper">
              <input id="login_password" name="password" type="password" required autocomplete="off" data-i18n-placeholder="login.label.password">
              <button type="button" id="toggle_password" class="password-toggle" aria-label="Show password" title="Show password">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </button>
            </div>
          </div>
          <div class="login-remember">
            <label class="remember-toggle" for="login_remember">
              <input id="login_remember" name="remember" type="checkbox">
              <span data-i18n="login.remember.label">Remember me next time</span>
            </label>
          </div>
          <div class="login-actions">
            <button type="submit" class="login-button" id="login_submit" data-i18n="login.button.submit">Sign in</button>
            <button type="button" class="login-button" id="login_reset" style="background:#334155" hidden data-i18n="login.button.reset">Return to sign in</button>
          </div>
        </form>
        <div id="login_status" class="login-status" aria-live="polite"></div>
        <div class="login-footer">
          <div class="login-help" data-i18n="login.help">Need access? Contact your administrator.</div>
        </div>
      </div>
    </div>

    <script>
      (function() {
        const SUPPORTED_LANGS = (window.qtilerLang && Array.isArray(window.qtilerLang.SUPPORTED_LANGS))
          ? window.qtilerLang.SUPPORTED_LANGS
          : ["en", "es", "sv"];
        const normalizeLang = window.qtilerLang?.normalize || ((value) => {
          const raw = (value || "").toLowerCase();
          if (SUPPORTED_LANGS.includes(raw)) return raw;
          const base = raw.split("-")[0];
          return SUPPORTED_LANGS.includes(base) ? base : "en";
        });

        // DOM element references
        const form = document.getElementById('login_form');
        const usernameInput = document.getElementById('login_username');
        const passwordInput = document.getElementById('login_password');
        const togglePasswordBtn = document.getElementById('toggle_password');
        const rememberCheckbox = document.getElementById('login_remember');
        const submitBtn = document.getElementById('login_submit');
        const resetBtn = document.getElementById('login_reset');
        const statusEl = document.getElementById('login_status');
        const languageSelect = document.getElementById('lang_select');
        
        if (togglePasswordBtn && passwordInput) {
          togglePasswordBtn.addEventListener('click', () => {
            const isPassword = passwordInput.type === 'password';
            passwordInput.type = isPassword ? 'text' : 'password';
            togglePasswordBtn.innerHTML = isPassword 
              ? `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`
              : `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
            togglePasswordBtn.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
          });
        }

        const REMEMBER_KEY = 'qtiler.login.remember';
        let currentLang = window.qtilerLang?.get?.() || normalizeLang(localStorage.getItem("qtiler.lang") || navigator.language || "en");

        const TRANSLATIONS = {
          en: {
            'login.pageTitle': 'Sign in · Qtiler',
            'login.heading': 'Sign in to Qtiler',
            'login.intro': 'Authenticate with your credentials to access the dashboard.',
            'login.label.username': 'Username',
            'login.label.password': 'Password',
            'login.remember.label': 'Remember me next time',
            'login.button.submit': 'Sign in',
            'login.button.reset': 'Return to sign in',
            'login.help': 'Need access? Contact your administrator.',
            'login.status.busy': 'Signing in…',
            'login.success.limitedNamed': 'Signed in as {user}',
            'login.success.limited': 'Signed in successfully',
            'login.error.invalidCredentials': 'Invalid username or password',
            'login.error.network': 'Connection error. Please try again.',
            'login.error.userDisabled': 'This account has been disabled'
          },
          es: {
            'login.pageTitle': 'Iniciar sesión · Qtiler',
            'login.heading': 'Iniciar sesión en Qtiler',
            'login.intro': 'Autentícate con tus credenciales para acceder al panel.',
            'login.label.username': 'Usuario',
            'login.label.password': 'Contraseña',
            'login.remember.label': 'Recordarme la próxima vez',
            'login.button.submit': 'Iniciar sesión',
            'login.button.reset': 'Volver al inicio de sesión',
            'login.help': '¿Necesitas acceso? Contacta con tu administrador.',
            'login.status.busy': 'Iniciando sesión…',
            'login.success.limitedNamed': 'Sesión iniciada como {user}',
            'login.success.limited': 'Sesión iniciada correctamente',
            'login.error.invalidCredentials': 'Usuario o contraseña incorrectos',
            'login.error.network': 'Error de conexión. Inténtalo de nuevo.',
            'login.error.userDisabled': 'Esta cuenta ha sido deshabilitada'
          },
          sv: {
            'login.pageTitle': 'Logga in · Qtiler',
            'login.heading': 'Logga in på Qtiler',
            'login.intro': 'Autentisera med dina uppgifter för att komma åt instrumentpanelen.',
            'login.label.username': 'Användarnamn',
            'login.label.password': 'Lösenord',
            'login.remember.label': 'Kom ihåg mig nästa gång',
            'login.button.submit': 'Logga in',
            'login.button.reset': 'Återgå till inloggning',
            'login.help': 'Behöver du åtkomst? Kontakta din administratör.',
            'login.status.busy': 'Loggar in…',
            'login.success.limitedNamed': 'Inloggad som {user}',
            'login.success.limited': 'Inloggad',
            'login.error.invalidCredentials': 'Ogiltigt användarnamn eller lösenord',
            'login.error.network': 'Anslutningsfel. Försök igen.',
            'login.error.userDisabled': 'Detta konto har inaktiverats'
          }
        };

        const ERROR_KEY_MAP = {
          'invalid_credentials': 'login.error.invalidCredentials',
          'user_disabled': 'login.error.userDisabled',
          'missing_credentials': 'login.error.invalidCredentials'
        };

        let busy = false;
        let statusState = { key: null, params: {}, text: '', state: '' };
        let tokenTtlSeconds = 86400;

        const persistRemembered = (username) => {
          try {
            if (username && username.trim()) {
              localStorage.setItem(REMEMBER_KEY, JSON.stringify({ username: username.trim() }));
            } else {
              localStorage.removeItem(REMEMBER_KEY);
            }
          } catch {}
        };

        const readRemembered = () => {
          try {
            const raw = localStorage.getItem(REMEMBER_KEY);
            if (!raw) return null;
            return JSON.parse(raw);
          } catch {
            return null;
          }
        };

        const syncRememberState = () => {
          const saved = readRemembered();
          if (rememberCheckbox) {
            rememberCheckbox.checked = !!(saved && saved.username);
          }
          if (saved && saved.username && usernameInput && !usernameInput.value) {
            usernameInput.value = saved.username;
          }
        };

        const tr = (key, replacements = {}) => {
          if (!key) return '';
          const table = TRANSLATIONS[currentLang] || {};
          const template = table[key] ?? (TRANSLATIONS.en && TRANSLATIONS.en[key]) ?? key;
          return template.replace(/\{(\w+)\}/g, (_, token) => (token in replacements ? replacements[token] : ''));
        };

        const renderStatus = () => {
          if (!statusEl) return;
          let message = '';
          if (statusState.key) {
            message = tr(statusState.key, statusState.params || {});
          } else if (statusState.text) {
            message = statusState.text;
          }
          statusEl.textContent = message;
          statusEl.dataset.state = statusState.state || '';
        };

        const setStatus = ({ key = null, params = {}, text = '', state = '' } = {}) => {
          statusState = { key, params, text, state };
          renderStatus();
        };

        const applyTranslations = () => {
          if (document?.documentElement) {
            document.documentElement.setAttribute('lang', currentLang);
          }
          const pageTitle = document.querySelector('title[data-i18n="login.pageTitle"]');
          if (pageTitle) pageTitle.textContent = tr('login.pageTitle');
          document.querySelectorAll('[data-i18n]').forEach((el) => {
            const key = el.getAttribute('data-i18n');
            if (!key) return;
            el.textContent = tr(key);
          });
          document.querySelectorAll('[data-i18n-placeholder]').forEach((el) => {
            const key = el.getAttribute('data-i18n-placeholder');
            if (!key) return;
            el.placeholder = tr(key);
          });
          submitBtn.textContent = busy ? tr('login.status.busy') : tr('login.button.submit');
          resetBtn.textContent = tr('login.button.reset');
          if (languageSelect) {
            languageSelect.value = currentLang;
          }
          renderStatus();
        };

        const setBusy = (value) => {
          busy = !!value;
          submitBtn.disabled = busy;
          submitBtn.textContent = busy ? tr('login.status.busy') : tr('login.button.submit');
          if (busy) {
            setStatus();
          }
        };

        const handleSuccess = (user) => {
          window.location.href = '/index.html';
        };

        const handleError = async (response) => {
          let key = 'login.error.invalidCredentials';
          let detailText = '';
          try {
            const data = await response.json();
            if (data && (data.error || data.message)) {
              const mappedKey = ERROR_KEY_MAP[data.error] || ERROR_KEY_MAP[data.message];
              if (mappedKey) {
                key = mappedKey;
              } else {
                detailText = data.message || data.error;
              }
            }
          } catch (err) {
            // ignore parse errors
          }
          setStatus({ key, text: detailText, state: 'error' });
        };

        form.addEventListener('submit', async (event) => {
          event.preventDefault();
          setBusy(true);
          try {
            const payload = {
              username: usernameInput.value.trim(),
              password: passwordInput.value
            };
            if (rememberCheckbox) {
              if (rememberCheckbox.checked) {
                persistRemembered(payload.username);
              } else {
                persistRemembered('');
              }
            }
            const response = await fetch('/auth/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(payload)
            });
            if (!response.ok) {
              await handleError(response);
              passwordInput.value = '';
              passwordInput.focus();
              return;
            }
            const data = await response.json();
            handleSuccess(data?.user || null);
          } catch (err) {
            setStatus({ key: 'login.error.network', state: 'error' });
          } finally {
            setBusy(false);
          }
        });

        resetBtn.addEventListener('click', () => {
          submitBtn.hidden = false;
          setBusy(false);
          resetBtn.hidden = true;
          setStatus();
        });

        const checkSession = async () => {
          try {
            const response = await fetch('/auth/me', { credentials: 'include' });
            if (!response.ok) return;
            const data = await response.json();
            if (data && data.user) {
              handleSuccess(data.user);
            }
          } catch (err) {
            // ignore
          }
        };

        const setLanguage = (lang) => {
          if (window.qtilerLang?.set) {
            window.qtilerLang.set(lang);
            return;
          }
          currentLang = normalizeLang(lang);
          try {
            localStorage.setItem('qtiler.lang', currentLang);
          } catch {}
          applyTranslations();
        };

        if (languageSelect) {
          languageSelect.value = currentLang;
          languageSelect.addEventListener('change', (event) => setLanguage(event.target.value));
        }

        if (rememberCheckbox) {
          rememberCheckbox.addEventListener('change', () => {
            if (rememberCheckbox.checked) {
              persistRemembered(usernameInput.value.trim());
            } else {
              persistRemembered('');
            }
          });
        }

        if (usernameInput && rememberCheckbox) {
          usernameInput.addEventListener('blur', () => {
            if (rememberCheckbox.checked) {
              persistRemembered(usernameInput.value.trim());
            }
          });
        }

        if (window.qtilerLang?.subscribe) {
          window.qtilerLang.subscribe((lang) => {
            const normalized = normalizeLang(lang);
            if (normalized === currentLang) return;
            currentLang = normalized;
            applyTranslations();
          });
        }

        syncRememberState();
        applyTranslations();
        checkSession();
      })();
    </script>
<%- include('partials/html-close') %>
